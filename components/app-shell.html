<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="inventory-card.html">
<link rel="import" href="register-card.html">
<link rel="import" href="cart-control.html">
<link rel="import" href="filter-card.html">
<link rel="import" href="search-card.html">
<link rel="import" href="login-card.html">
<link rel="import" href="item-tray.html">
<link rel="import" href="item-card.html">

<dom-module id="app-shell">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        font-family: Roboto;
      }
    </style>
    <style is="custom-style">
      paper-toolbar {
        --paper-toolbar-sm-height: 64px;
      }
    </style>
    
    <paper-drawer-panel id="drawer">
      <paper-header-panel drawer>
        <paper-toolbar>
          <div class="title">Menu</div>
        </paper-toolbar>
        <div class="layout vertical center-justified">
          <login-card id="login"></login-card>
          <register-card id="register"></register-card>
          <search-card></search-card>
          <filter-card filter="{{filters}}"></filter-card>
        </div>
      </paper-header-panel>
      <paper-scroll-header-panel main>
        <paper-toolbar>
          <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
          <div class="title">Simple Store</div>
          
          <paper-tabs id="tabs" class="end-justified" selected="{{activeTab}}">
              <paper-tab>BROWSE</paper-tab>
              <template is="dom-if" if="{{isAdmin}}">
                <paper-tab>INVENTORY</paper-tab>
              </template>
          </paper-tabs>
          
          <template is="dom-if" if="{{loggedIn}}">
            <cart-control></cart-control>
          </template>
        </paper-toolbar>
        
        <div class="content">
        <iron-pages selected="{{activeTab}}">
          <div>
            <item-tray stale="{{reloadItems}}" filterList="{{filters}}"></item-tray>
          </div>
          
          <template id="invTemplate" is="dom-if" if="{{isAdmin}}">
            <div>
              <inventory-card on-stale-product="staleItems"></inventory-card>
            </div>
          </template>
          
        </iron-pages>
        </div>
        
      </paper-scroll-header-panel>
    </paper-drawer-panel>
    
  </template>

  <script>
    Polymer({
      is: "app-shell",
      properties: {
        loggedIn: {
          type: Boolean,
          readyOnly: true,
          value: false
        },
        filters: {
          type: Array,
          value: [],
          notify: true
        },
        isStaff: {
          type: Boolean,
          default: false
        },
        isManager: {
          type: Boolean,
          default: false
        },
        isAdmin: {
          type: Boolean,
          value: false,
          notify: true,
          computed: 'computeAdmin(isStaff, isManager)'
        },
        activeTab: {
          type: Number,
          value: 0,
          notify: true
        },
        reloadItems: {
          type: Boolean,
          value: false,
          notify: true
        }
      },
      listeners: {
        'login.login-changed': 'setLogin',
        'login.register': 'showRegisterCard',
        'register.register-success': 'showLoginCard'
      },
      setLogin: function(e) {
        console.log("login update:", e.detail);
        this.loggedIn = e.detail.loggedIn;
        
        if(this.loggedIn) {
          this.isStaff = e.detail.isStaff;
          this.isManager = e.detail.isManager;
        } else {
          this.isStaff = false;
          this.isManager = false;
          this.activeTab = 0;
        }
      },
      showRegisterCard: function() {
        this.$.login.visible = false;
        this.$.register.visible = true;
      },
      showLoginCard: function(e) {
        if(e.detail.registered)
          this.$.login.registerVisible = false;
        this.$.login.visible = true;
      },
      computeAdmin: function(isStaff, isManager) {
        console.log("isAdmin:", isStaff || isManager);
        return isStaff || isManager;
      },
      staleItems: function(e) {
        console.log("stale items, refreshing");
        document.querySelector('item-tray').refresh();
      }
    });
  </script>

</dom-module>
